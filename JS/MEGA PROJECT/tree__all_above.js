const data_main = ["VET908-217653"];
const data_component = [
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216630",
    parent_mat_no: "VET908-217653",
    qpa: 6,
    seq_no: "1",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216630",
    component_no: "VET01E-216630A",
    parent_mat_no: "VET01R-216630",
    qpa: 1,
    seq_no: "1.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216630A",
    component_no: "VET01E-216630B",
    parent_mat_no: "VET01E-216630A",
    qpa: 1,
    seq_no: "1.1.1",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216631",
    parent_mat_no: "VET908-217653",
    qpa: 3,
    seq_no: "2",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216631",
    component_no: "VET01E-216631A",
    parent_mat_no: "VET01R-216631",
    qpa: 1,
    seq_no: "2.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216631A",
    component_no: "VET01E-216630B",
    parent_mat_no: "VET01E-216631A",
    qpa: 1,
    seq_no: "2.1.2",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01P-217654",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "3",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216632",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "4",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216632",
    component_no: "VET01E-216632",
    parent_mat_no: "VET01R-216632",
    qpa: 1,
    seq_no: "4.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216632",
    component_no: "VET01P-9002111LF",
    parent_mat_no: "VET01E-216632",
    qpa: 1,
    seq_no: "4.1.2",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216632",
    component_no: "VET01P-9002114LF",
    parent_mat_no: "VET01E-216632",
    qpa: 1,
    seq_no: "4.1.3",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216633",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "5",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216633",
    component_no: "VET01E-216633A",
    parent_mat_no: "VET01R-216633",
    qpa: 4,
    seq_no: "5.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216633",
    component_no: "VET01E-216633B",
    parent_mat_no: "VET01R-216633",
    qpa: 1,
    seq_no: "5.2",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216633B",
    component_no: "VET01E-216633C",
    parent_mat_no: "VET01E-216633B",
    qpa: 1,
    seq_no: "5.2.1",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216634",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "6",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216634",
    component_no: "VET01E-216634A",
    parent_mat_no: "VET01R-216634",
    qpa: 1,
    seq_no: "6.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216634",
    component_no: "VET01E-216633A",
    parent_mat_no: "VET01R-216634",
    qpa: 2,
    seq_no: "6.2",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216634",
    component_no: "VET01E-216633B",
    parent_mat_no: "VET01R-216634",
    qpa: 1,
    seq_no: "6.3",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216633B",
    component_no: "VET01E-216633C",
    parent_mat_no: "VET01E-216633B",
    qpa: 1,
    seq_no: "6.3.3",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216634",
    component_no: "VET01E-216635A",
    parent_mat_no: "VET01R-216634",
    qpa: 1,
    seq_no: "6.4",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216635",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "7",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216635",
    component_no: "VET01E-216635A",
    parent_mat_no: "VET01R-216635",
    qpa: 1,
    seq_no: "7.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216635",
    component_no: "VET01E-216633A",
    parent_mat_no: "VET01R-216635",
    qpa: 3,
    seq_no: "7.2",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216635",
    component_no: "VET01E-216633B",
    parent_mat_no: "VET01R-216635",
    qpa: 1,
    seq_no: "7.3",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216633B",
    component_no: "VET01E-216633C",
    parent_mat_no: "VET01E-216633B",
    qpa: 1,
    seq_no: "7.3.5",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-217655",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "8",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-217655",
    component_no: "VET01E-217655",
    parent_mat_no: "VET01R-217655",
    qpa: 1,
    seq_no: "8.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216636",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "9",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216636",
    component_no: "VET01E-216636A",
    parent_mat_no: "VET01R-216636",
    qpa: 1,
    seq_no: "9.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216636A",
    component_no: "VET01P-9002111LF",
    parent_mat_no: "VET01E-216636A",
    qpa: 1,
    seq_no: "9.1.2",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216636",
    component_no: "VET01E-216636B",
    parent_mat_no: "VET01R-216636",
    qpa: 1,
    seq_no: "9.2",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216637",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "10",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216637",
    component_no: "VET01E-216637",
    parent_mat_no: "VET01R-216637",
    qpa: 1,
    seq_no: "10.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216638",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "11",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216638",
    component_no: "VET01E-216638",
    parent_mat_no: "VET01R-216638",
    qpa: 1,
    seq_no: "11.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216638",
    component_no: "VET01P-9002114LF",
    parent_mat_no: "VET01E-216638",
    qpa: 1,
    seq_no: "11.1.3",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-216639",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "12",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-216639",
    component_no: "VET01E-216639",
    parent_mat_no: "VET01R-216639",
    qpa: 1,
    seq_no: "12.1",
    level_no: 2,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01E-216639",
    component_no: "VET01P-9002112LF",
    parent_mat_no: "VET01E-216639",
    qpa: 1,
    seq_no: "12.1.2",
    level_no: 3,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET908-217653",
    component_no: "VET01R-217656",
    parent_mat_no: "VET908-217653",
    qpa: 1,
    seq_no: "13",
    level_no: 1,
  },
  {
    fg_material_no: "VET908-217653",
    material_no: "VET01R-217656",
    component_no: "VET01E-217656",
    parent_mat_no: "VET01R-217656",
    qpa: 1,
    seq_no: "13.1",
    level_no: 2,
  },
];

// ฟังก์ชันสำหรับสร้างโครงสร้างซ้อน
function createNestedStructure(rootId, data_component) {
  let root = {
    main_id: rootId,
    parent_id: rootId,
    child_id: rootId,
    seq_no: "0",
    level_no: 0, // root node เริ่มที่ level 0
    fg_qty: 0,
    qpa: 1,
    wo_total: 0,
    plan_total: 0,
    so_total: 0,
    total: 0,
    wo_len: 0,
    so_len: 0,
    cmp_kit: 0,
    parent_total: 0,
    detail: [
      {
        main_id: rootId,
        parent_id: rootId,
        child_id: rootId,
        level_no: 0, // root node เริ่มที่ level 0
        seq_no: 0,
        summary: "I",
      },
    ],
    child: [],
  };

  // สร้างแผนที่ (map) ของ seq_no เพื่อลิงก์ parent-child
  let componentMap = {};
  componentMap[rootId] = root;

  data_component.forEach((item) => {
    if (item.fg_material_no === rootId) {
      let parent = componentMap[item.parent_mat_no];

      // ถ้ามี parent อยู่
      if (parent) {
        // สร้าง child ใหม่โดยตั้ง level_no เป็น level_no ของ parent + 1
        let newChild = {
          main_id: item.fg_material_no,
          parent_id: item.parent_mat_no,
          child_id: item.component_no,
          seq_no: item.seq_no,
          level_no: parent.level_no + 1, // เพิ่ม level_no ขึ้น 1
          fg_qty: 0,
          qpa: item.qpa,
          wo_total: 0,
          plan_total: 0,
          so_total: 0,
          total: 0,
          wo_len: 0,
          so_len: 0,
          parent_total: 0,
          detail: [
            {
              main_id: item.fg_material_no,
              parent_id: item.parent_mat_no,
              child_id: item.component_no,
              level_no: parent.level_no + 1, // ระบุ level_no ในรายละเอียดด้วย
              seq_no: item.seq_no,
              summary: "I",
            },
          ],
          child: [],
        };
        parent.child.push(newChild); // เพิ่ม child ใหม่ลงใน parent
        componentMap[item.component_no] = newChild; // เก็บ newChild ใน componentMap
      }
    }
  });
  return root;
}

// สร้างโครงสร้างสำหรับแต่ละ rootId ใน data_main
let tree_structure = {};
data_main.forEach((rootId) => {
  tree_structure[rootId] = createNestedStructure(rootId, data_component);
});

// console.log(JSON.stringify(tree_structure, null, 2));
//////////////////////////////////////////////////////////// TREE ROOT FG ////////////////////////////////////////////////////////////
////////// SO 908 ONLY //////////
function Structure_SO_908(data) {
  const tree = data.reduce((acc, entry) => {
    if (!acc[entry.fg_material_no]) {
      acc[entry.fg_material_no] = []; // สร้าง array ถ้ายังไม่มี
    }
    acc[entry.fg_material_no].push(entry); // เพิ่ม entry เข้าไปใน array
    return acc;
  }, {});
  return tree;
}

////////// WO 908  //////////
function Structure_WO_908(data) {
  const tree = data.reduce((acc, entry) => {
    if (!acc[entry.material_no]) {
      acc[entry.material_no] = []; // สร้าง array ถ้ายังไม่มี
    }
    acc[entry.material_no].push(entry); // เพิ่ม entry เข้าไปใน array
    return acc;
  }, {});
  return tree;
}

////////// PLAN 908  //////////
// function Structure_WO_908(data) {
//   const tree = data.reduce((acc, entry) => {
//     if (!acc[entry.material_no]) {
//       acc[entry.material_no] = []; // สร้าง array ถ้ายังไม่มี
//     }
//     acc[entry.material_no].push(entry); // เพิ่ม entry เข้าไปใน array
//     return acc;
//   }, {});
//   return tree;
// }
//////////////////////////////////////////////////////////// SO_908 ////////////////////////////////////////////////////////////
data_so_908 = [
  {
    fg_material_no: "VET908-217653",
    plant: "SVI2",
    qpa: 1,
    so: "0212186987",
    so_item: "000010",
    so_qty: 2,
    so_workweek: "2024-46",
    so_net_price: 1435.54,
    so_amount: 2871.08,
    // fg_qty: 2,
    fg_qty: 1,
    cmp_kit: 1092,
  },
  {
    fg_material_no: "VET908-217653",
    plant: "SVI2",
    qpa: 1,
    so: "0212187511",
    so_item: "000010",
    // so_qty: 8,
    so_qty: 200,
    so_workweek: "2024-47",
    so_net_price: 1435.54,
    so_amount: 11484.32,
    // fg_qty: 2,
    fg_qty: 1,
    cmp_kit: 1092,
  },
  {
    fg_material_no: "VET908-217653",
    plant: "SVI2",
    qpa: 1,
    so: "0212189147",
    so_item: "000010",
    so_qty: 2,
    // so_qty: 50,
    so_workweek: "2024-47",
    so_net_price: 1435.54,
    so_amount: 2871.08,
    // fg_qty: 2,
    fg_qty: 1,
    cmp_kit: 1092,
  },
];
// console.log( Structure_SO_908(data_so_908))
let tree_so = Structure_SO_908(data_so_908);
function updateDetails_SO908(tree_structure, tree_so) {
  // เตรียม Tree_SO ไว้คำนวณ
  for (let materialNo in tree_so) {
    // console.log(materialNo)
    let fg_total = 0;
    const entries = tree_so[materialNo];
    entries.forEach((entry, index) => {
      // console.log(entry)
      const node = tree_structure[materialNo];
      if (index === 0) {
        //////// MAIN //////////
        node.fg_qty = entry.fg_qty;
        fg_total = entry.fg_qty;
        node.qpa = entry.qpa;
        node.cmp_kit = entry.cmp_kit;
        //////// Detail ////////
        node.detail[0].fg_qty = entry.fg_qty;
        node.detail[0].qpa = entry.qpa;
        node.detail[0].cmp_kit = entry.cmp_kit;
        node.detail[0].so = entry.so;
        node.detail[0].so_item = entry.so_item;
        node.detail[0].so_qty = entry.so_qty;
        node.detail[0].so_workweek = entry.so_workweek;
        node.detail[0].so_net_price = entry.so_net_price;
        node.detail[0].so_amount = entry.so_amount;
      } else {
        let newDetail = {
          main_id: materialNo,
          parent_id: materialNo,
          child_id: materialNo,
          fg_qty: entry.fg_qty,
          qpa: entry.qpa,
          cmp_kit: entry.cmp_kit,
          so: entry.so,
          so_item: entry.so_item,
          so_qty: entry.so_qty,
          so_workweek: entry.so_workweek,
          so_net_price: entry.so_net_price,
          so_amount: entry.so_amount,
        };
        node.detail.push(newDetail);
        fg_total = 0;
      }
      node.so_len += 1;
      node.so_total += entry.so_qty;
      //////////////////////////////////////
      node.total += fg_total - entry.so_qty;
    });
  }
}
updateDetails_SO908(tree_structure, tree_so);
// console.log(JSON.stringify(tree_structure, null, 2));
// console.log( tree_structure)
// //////////////////////////////////////////////////////////// WO_908 ////////////////////////////////////////////////////////////
// cal_kit คือ percent cal_kit_w1 ตัวใหม่
data_wo_908 = [
  {
    material_no: "VET908-217653",
    work_order: "211100406333",
    plan_order: null,
    qty: 20,
    balance: 20,
    start_date: "2024-10-24T17:00:00.000Z",
    status: "CRTD",
    type: "908",
    cal_kit: 0,
    count_cal_kit: 0,
    cal_kit_w1: 0,
    count_cal_kit_w1: 12,
  },
  // {"material_no":"VET908-217653","work_order":"211100406333","plan_order":null,"qty":20,"balance":20,"start_date":"2024-10-24T17:00:00.000Z","status":"CRTD","type":"908","cal_kit":0,"count_cal_kit":0,"cal_kit_w1":0,"count_cal_kit_w1":12},
  // {"material_no":"VET908-217653","work_order":"211100406333","plan_order":null,"qty":20,"balance":20,"start_date":"2024-10-24T17:00:00.000Z","status":"CRTD","type":"908","cal_kit":0,"count_cal_kit":0,"cal_kit_w1":0,"count_cal_kit_w1":12},
  // {"material_no":"VET908-217653","work_order":"211100406333","plan_order":null,"qty":20,"balance":20,"start_date":"2024-10-24T17:00:00.000Z","status":"CRTD","type":"908","cal_kit":0,"count_cal_kit":0,"cal_kit_w1":0,"count_cal_kit_w1":12},
];
// console.log(Structure_WO_908(data_wo_908))
let tree_wo = Structure_WO_908(data_wo_908);
updateDetails_WO908(tree_structure, tree_wo);
function updateDetails_WO908(tree_structure, tree_wo) {
  // เตรียม Tree_SO ไว้คำนวณ
  for (let materialNo in tree_wo) {
    // console.log(materialNo)
    const entries = tree_wo[materialNo];
    // console.log(entries)
    entries.forEach((entry, index) => {
      // console.log(entry)
      const node = tree_structure[materialNo];
      // console.log('X',node['wo_len'])
      if (node["wo_len"] < node["so_len"]) {
        let no_order = node["wo_len"];
        node.detail[no_order].work_order = entry.work_order;
        node.detail[no_order].plan_order = null;
        node.detail[no_order].wo_status = entry.status;
        node.detail[no_order].wo_qty = entry.qty;
        node.detail[no_order].wo_balance = entry.balance;
        node.detail[no_order].wo_date = entry.start_date;
        node.detail[no_order].cplk_per_o = entry.cal_kit;
        node.detail[no_order].cplk_count_o = entry.count_cal_kit;
        node.detail[no_order].cplk_per_n = entry.cal_kit_w1;
        node.detail[no_order].cplk_count_n = entry.count_cal_kit_w1;
      } else {
        const newDetail = {
          main_id: node.main_id,
          parent_id: node.parent_id,
          child_id: node.child_id,
          work_order: entry.work_order,
          plan_order: null,
          wo_qty: entry.qty,
          wo_status: entry.status,
          wo_balance: entry.balance,
          wo_date: entry.start_date,
          cplk_per_o: entry.cal_kit,
          cplk_count_o: entry.count_cal_kit,
          cplk_per_n: entry.cal_kit_w1,
          cplk_count_n: entry.count_cal_kit_w1,
        };
        node.detail.push(newDetail);
      }
      node["wo_total"] += entry.qty;
      node["wo_len"] += 1;
      node["total"] += entry.qty;
    });
  }
}
// console.log(tree_structure);
// console.log(JSON.stringify(tree_structure, null, 2));
//////////////////////////////////////////////////////////// PLAN_908 ////////////////////////////////////////////////////////////
function findMissingPlanQuantity_908(tree_structure) {
  let findplan_908 = [];
  for (let key in tree_structure) {
    const entries = tree_structure[key];
    // ตรวจสอบระดับและค่า total
    if (entries["level_no"] == 0 && entries["total"] < 0) {
      // เช็คว่าค่า key ยังไม่อยู่ใน findplan_908
      if (!findplan_908.includes(key)) {
        findplan_908.push(key); // เพิ่ม key ลงใน findplan_908
      }
    }
  }
  return findplan_908; // คืนค่าผลลัพธ์
}

let findplan_908 = [];
findplan_908 = findMissingPlanQuantity_908(tree_structure);
//////////////////////////////////////////////////////////////// กรณี หา 908 เข้ามา
data_plan_908 = [
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435246",
    qty: 44.0,
    balance: 44.0,
    start_date: "2025-02-24",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435247",
    qty: 4.0,
    balance: 4.0,
    start_date: "2025-03-18",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435248",
    qty: 2.0,
    balance: 2.0,
    start_date: "2025-03-21",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435249",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-04-26",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435250",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-06-30",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435251",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-09-01",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435252",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-10-27",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET908-217653",
    work_order: null,
    plan_order: "0158435253",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-11-29",
    status: "PLAN",
    type: "908",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
];
function updateDetails_PLAN908(tree_structure, tree_wo) {
  // เตรียม Tree_SO ไว้คำนวณ
  for (let materialNo in tree_wo) {
    const entries = tree_wo[materialNo];
    entries.forEach((entry, index) => {
      const node = tree_structure[materialNo];
      if (node["total"] < 0) {
        if (node["wo_len"] < node["so_len"]) {
          no_order = node["wo_len"];
          node.detail[no_order].work_order = null;
          node.detail[no_order].plan_order = entry.plan_order;
          node.detail[no_order].wo_status = entry.status;
          node.detail[no_order].wo_qty = entry.qty;
          node.detail[no_order].wo_balance = entry.balance;
          node.detail[no_order].wo_date = entry.start_date;
          node.detail[no_order].cplk_per_o = entry.cal_kit;
          node.detail[no_order].cplk_count_o = entry.count_cal_kit;
          node.detail[no_order].cplk_per_n = entry.cal_kit_w1;
          node.detail[no_order].cplk_count_n = entry.count_cal_kit_w1;
        } else {
          const newDetail = {
            main_id: node.main_id,
            parent_id: node.parent_id,
            child_id: node.child_id,
            work_order: null,
            plan_order: entry.plan_order,
            wo_qty: entry.qty,
            wo_status: entry.status,
            wo_balance: entry.balance,
            wo_date: entry.start_date,
            cplk_per_o: entry.cal_kit,
            cplk_count_o: entry.count_cal_kit,
            cplk_per_n: entry.cal_kit_w1,
            cplk_count_n: entry.count_cal_kit_w1,
          };
          node.detail.push(newDetail);
        }
        node["plan_total"] += entry.qty;
        node["wo_len"] += 1;
        node["total"] += entry.qty;
      }
    });
  }
}

if (findplan_908.length > 0) {
  let tree_plan = Structure_WO_908(data_plan_908);
  updateDetails_PLAN908(tree_structure, tree_plan);
} else {
  console.log("no");
}
// console.log(tree_structure);
//////////////////////////////////////////////////////////////// หา 908 ปรับหมดแล้วให้ ปรับ varince
// console.log(JSON.stringify(tree_structure, null, 2));
update908Varince(tree_structure);
function update908Varince(tree_structure) {
  for (let key in tree_structure) {
    // console.log(key)
    let node = tree_structure[key];
    // console.log(node);
    if (node["level_no"] === 0) {
      let temp_total = 0;
      node["parent_total"] =
        (node["wo_total"] + node["plan_total"]) * node["qpa"] || 1;
      node["detail"].forEach((entry, index) => {
        if (index === 0) {
          temp_total = node["fg_qty"] + node["wo_total"] - entry.so_qty || 0;
          node.detail[index].variance = temp_total;
          // console.log(entry.so_qty);
        } else {
          if (temp_total > 0) {
            temp_total -= entry.so_qty || 0;
            node.detail[index].variance = temp_total;
          } else {
            node.detail[index].variance = -entry.so_qty || 0;
          }
        }
        // console.log(entry);
      });
    }
  }
}
// console.log(tree_structure);
//////////////////////////////////////////////////////////////// ปรับลูก TOTAL CHILD ////////////////////////////////////////////////////////////////
// console.log(JSON.stringify(tree_structure, null, 2));
function calculateParentTotalRecursive(node) {
  // กำหนดค่าเริ่มต้นของ parent_total ถ้ายังไม่มี
  if (!node.parent_total) {
    node.parent_total = 1; // หรือค่า default อื่นๆ
  }

  // ตรวจสอบว่ามี child หรือไม่
  if (node.child && node.child.length > 0) {
    for (let i = 0; i < node.child.length; i++) {
      let childNode = node.child[i];

      // คำนวณ parent_total ของลูก: parent_total ของแม่ * qpa ของลูก
      // OLD
      // childNode.parent_total = node.parent_total * childNode.qpa;

      // NEW
      p_total = node.parent_total * childNode.qpa;
      childNode.parent_total = p_total;

      /////////////////////////////////////////////
      childNode.total = p_total;
      // เรียกฟังก์ชันซ้ำเพื่อคำนวณลูกๆ ต่อไป
      calculateParentTotalRecursive(childNode);
    }
  }
}
function updateParentTotal(tree_structure) {
  // เรียกฟังก์ชันคำนวณ parent_total สำหรับทุกโหนดใน tree_structure
  for (let key in tree_structure) {
    const node = tree_structure[key];
    calculateParentTotalRecursive(node);
  }
}
// เรียกใช้ฟังก์ชันเพื่ออัปเดต parent_total
updateParentTotal(tree_structure);
// console.log(JSON.stringify(tree_structure, null, 2));
/////////////////////////////////////////////////////////////    WO ค้น LEVEL > 0    ///////////////////////////////////////////////////////////////////
//////////////////// ค้นหา WO ที่เริ่ม level_1 ไว้เอาไปค้นหา WO ทำใน NODE
function findUniqueNodesWithLevelGreaterThanZero(tree_structure) {
  let uniqueNodes = new Set(); // ใช้ Set เพื่อเก็บค่าไม่ซ้ำกัน

  function traverseNode(node) {
    // ตรวจสอบว่า level_no มากกว่า 0
    if (node.level_no > 0) {
      uniqueNodes.add(node.child_id); // เก็บ child_id ไว้ใน Set
    }
    // ถ้ามี child ให้ทำการวนซ้ำเพื่อตรวจสอบ child แต่ละตัว
    if (node.child && node.child.length > 0) {
      for (let i = 0; i < node.child.length; i++) {
        traverseNode(node.child[i]); // ตรวจสอบ child ของโหนด
      }
    }
  }
  // วนลูปผ่าน tree_structure
  for (let key in tree_structure) {
    const node = tree_structure[key];
    traverseNode(node); // เริ่มการ traversal จากโหนดนี้
  }
  // แปลง Set ให้เป็น Array ถ้าต้องการ
  return Array.from(uniqueNodes);
}

// เรียกใช้งานฟังก์ชัน
const uniqueChildNodes =
  findUniqueNodesWithLevelGreaterThanZero(tree_structure);
// console.log(uniqueChildNodes);
///////////////////////////////////////////////////////////////////////////
function findNodeByChildId(node, targetChildId) {
  // ตรวจสอบว่า child_id ของ node ตรงกับที่เราต้องการหรือไม่
  if (node.child_id === targetChildId) {
    return node; // ถ้าตรง คืนค่าทั้ง node
  }

  // ถ้าไม่ตรง ให้ค้นหาใน child ของ node นี้
  for (const child of node.child) {
    const foundNode = findNodeByChildId(child, targetChildId);
    if (foundNode) {
      return foundNode; // ถ้าพบคืนค่า node ที่ค้นพบ
    }
  }

  return null; // ถ้าไม่พบคืนค่า null
}

function findAllNodesByChildId(node, targetChildId) {
  let foundNodes = [];

  // ตรวจสอบว่า child_id ของ node ตรงกับที่เราต้องการหรือไม่
  if (node.child_id === targetChildId) {
    foundNodes.push(node); // ถ้าตรงให้เก็บใน array
  }

  // ถ้าไม่ตรง ให้ค้นหาใน child ของ node นี้
  for (const child of node.child || []) {
    const childFoundNodes = findAllNodesByChildId(child, targetChildId); // ค้นหาในลูกๆ ต่อไป
    foundNodes = foundNodes.concat(childFoundNodes); // รวมผลการค้นหาจากลูกทุกตัว
  }

  return foundNodes; // คืนค่าทุก node ที่ค้นพบ
}

data_wo_child = [
  {
    material_no: "VET01E-216630A",
    work_order: "211100402523",
    plan_order: null,
    qty: 11.0,
    balance: 11.0,
    start_date: "2024-08-30",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216630A",
    work_order: "211100406381",
    plan_order: null,
    qty: 210.0,
    balance: 210.0,
    start_date: "2024-10-11",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 18.57142857142857,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-216630B",
    work_order: "211100406383",
    plan_order: null,
    qty: 360.0,
    balance: 360.0,
    start_date: "2024-10-11",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216631A",
    work_order: "211100401679",
    plan_order: null,
    qty: 14.0,
    balance: 14.0,
    start_date: "2024-08-21",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216631A",
    work_order: "211100406382",
    plan_order: null,
    qty: 175.0,
    balance: 175.0,
    start_date: "2024-10-11",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-216632",
    work_order: "211100401680",
    plan_order: null,
    qty: 8.0,
    balance: 8.0,
    start_date: "2024-08-05",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-216632",
    work_order: "211100407536",
    plan_order: null,
    qty: 22.0,
    balance: 22.0,
    start_date: "2024-11-04",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 2,
  },
  {
    material_no: "VET01E-216633A",
    work_order: "211100401681",
    plan_order: null,
    qty: 61.0,
    balance: 61.0,
    start_date: "2024-08-16",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216633A",
    work_order: "211100406384",
    plan_order: null,
    qty: 310.0,
    balance: 310.0,
    start_date: "2024-10-15",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216633A",
    work_order: "211100407995",
    plan_order: null,
    qty: 30.0,
    balance: 30.0,
    start_date: "2024-10-23",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216633B",
    work_order: "211100401684",
    plan_order: null,
    qty: 10.0,
    balance: 10.0,
    start_date: "2024-08-19",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216633B",
    work_order: "211100406387",
    plan_order: null,
    qty: 125.0,
    balance: 125.0,
    start_date: "2024-10-15",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 16.799999999999997,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-216633C",
    work_order: "211100401685",
    plan_order: null,
    qty: 20.0,
    balance: 20.0,
    start_date: "2024-08-16",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216633C",
    work_order: "211100406388",
    plan_order: null,
    qty: 120.0,
    balance: 120.0,
    start_date: "2024-10-11",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216634A",
    work_order: "211100401682",
    plan_order: null,
    qty: 20.0,
    balance: 20.0,
    start_date: "2024-08-16",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216634A",
    work_order: "211100406385",
    plan_order: null,
    qty: 60.0,
    balance: 60.0,
    start_date: "2024-10-15",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216634A",
    work_order: "211100407996",
    plan_order: null,
    qty: 20.0,
    balance: 20.0,
    start_date: "2024-10-23",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216635A",
    work_order: "211100406386",
    plan_order: null,
    qty: 130.0,
    balance: 130.0,
    start_date: "2024-10-15",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216636A",
    work_order: "211100401686",
    plan_order: null,
    qty: 1.0,
    balance: 1.0,
    start_date: "2024-08-02",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 74.71264367816092,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-216636A",
    work_order: "211100406389",
    plan_order: null,
    qty: 90.0,
    balance: 90.0,
    start_date: "2024-10-11",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-216636B",
    work_order: "211100405859",
    plan_order: null,
    qty: 20.0,
    balance: 20.0,
    start_date: "2024-09-27",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216636B",
    work_order: "211100406390",
    plan_order: null,
    qty: 84.0,
    balance: 84.0,
    start_date: "2024-10-11",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216636B",
    work_order: "211100407537",
    plan_order: null,
    qty: 10.0,
    balance: 10.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216637",
    work_order: "211100406916",
    plan_order: null,
    qty: 20.0,
    balance: 20.0,
    start_date: "2024-10-15",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216638",
    work_order: "211100401930",
    plan_order: null,
    qty: 13.0,
    balance: 13.0,
    start_date: "2024-08-16",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216638",
    work_order: "211100406391",
    plan_order: null,
    qty: 60.0,
    balance: 60.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 5,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 6,
  },
  {
    material_no: "VET01E-216639",
    work_order: "211100402525",
    plan_order: null,
    qty: 2.0,
    balance: 2.0,
    start_date: "2024-08-16",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-216639",
    work_order: "211100406392",
    plan_order: null,
    qty: 50.0,
    balance: 50.0,
    start_date: "2024-10-23",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 1,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 2,
  },
  {
    material_no: "VET01E-217655",
    work_order: "211100401691",
    plan_order: null,
    qty: 2.0,
    balance: 2.0,
    start_date: "2024-09-05",
    status: "REL",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217655",
    work_order: "211100406917",
    plan_order: null,
    qty: 25.0,
    balance: 25.0,
    start_date: "2024-11-04",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 1,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01E-217656",
    work_order: "211100404078",
    plan_order: null,
    qty: 17.0,
    balance: 17.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-9002111LF",
    work_order: "211100401696",
    plan_order: null,
    qty: 225.0,
    balance: 225.0,
    start_date: "2024-08-02",
    status: "REL",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-9002111LF",
    work_order: "211100406924",
    plan_order: null,
    qty: 50.0,
    balance: 50.0,
    start_date: "2024-10-10",
    status: "REL",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-9002112LF",
    work_order: "211100401697",
    plan_order: null,
    qty: 280.0,
    balance: 280.0,
    start_date: "2024-08-02",
    status: "REL",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-9002114LF",
    work_order: "211100406407",
    plan_order: null,
    qty: 400.0,
    balance: 400.0,
    start_date: "2024-10-10",
    status: "REL",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-216630",
    work_order: "211100406358",
    plan_order: null,
    qty: 210.0,
    balance: 210.0,
    start_date: "2024-10-21",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 1.4285714285714164,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216631",
    work_order: "211100406359",
    plan_order: null,
    qty: 175.0,
    balance: 175.0,
    start_date: "2024-10-21",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216632",
    work_order: "211100401665",
    plan_order: null,
    qty: 12.0,
    balance: 12.0,
    start_date: "2024-08-19",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216632",
    work_order: "211100407532",
    plan_order: null,
    qty: 96.0,
    balance: 96.0,
    start_date: "2024-11-04",
    status: "CRTD",
    type: "01R",
    cal_kit: 94.79166666666667,
    count_cal_kit: 1,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 2,
  },
  {
    material_no: "VET01R-216633",
    work_order: "211100401666",
    plan_order: null,
    qty: 11.0,
    balance: 11.0,
    start_date: "2024-08-22",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216633",
    work_order: "211100406361",
    plan_order: null,
    qty: 10.0,
    balance: 10.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 2,
  },
  {
    material_no: "VET01R-216634",
    work_order: "211100406362",
    plan_order: null,
    qty: 52.0,
    balance: 52.0,
    start_date: "2024-10-21",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 4,
  },
  {
    material_no: "VET01R-216634",
    work_order: "211100406906",
    plan_order: null,
    qty: 48.0,
    balance: 48.0,
    start_date: "2024-11-04",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 4,
  },
  {
    material_no: "VET01R-216635",
    work_order: "211100401668",
    plan_order: null,
    qty: 11.0,
    balance: 11.0,
    start_date: "2024-08-22",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216635",
    work_order: "211100406363",
    plan_order: null,
    qty: 44.0,
    balance: 44.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 3,
  },
  {
    material_no: "VET01R-216636",
    work_order: "211100401669",
    plan_order: null,
    qty: 3.0,
    balance: 3.0,
    start_date: "2024-08-26",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-216636",
    work_order: "211100405134",
    plan_order: null,
    qty: 48.0,
    balance: 48.0,
    start_date: "2024-10-15",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 4.166666666666657,
    count_cal_kit_w1: 2,
  },
  {
    material_no: "VET01R-216636",
    work_order: "211100406364",
    plan_order: null,
    qty: 45.0,
    balance: 45.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 11.111111111111114,
    count_cal_kit: 1,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 3,
  },
  {
    material_no: "VET01R-216637",
    work_order: "211100406365",
    plan_order: null,
    qty: 30.0,
    balance: 30.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 53.333333333333336,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216638",
    work_order: "211100402521",
    plan_order: null,
    qty: 7.0,
    balance: 7.0,
    start_date: "2024-09-05",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216638",
    work_order: "211100406366",
    plan_order: null,
    qty: 60.0,
    balance: 60.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-216639",
    work_order: "211100401672",
    plan_order: null,
    qty: 4.0,
    balance: 4.0,
    start_date: "2024-08-22",
    status: "REL",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-216639",
    work_order: "211100406367",
    plan_order: null,
    qty: 50.0,
    balance: 50.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 22.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-217655",
    work_order: "211100406368",
    plan_order: null,
    qty: 10.0,
    balance: 10.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217655",
    work_order: "211100406907",
    plan_order: null,
    qty: 25.0,
    balance: 25.0,
    start_date: "2024-11-04",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 1,
  },
  {
    material_no: "VET01R-217656",
    work_order: "211100404077",
    plan_order: null,
    qty: 17.0,
    balance: 17.0,
    start_date: "2024-10-24",
    status: "CRTD",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 11.764705882352942,
    count_cal_kit_w1: 1,
  },
];
//////////////////////////// TEST
// data_wo_child = [
//   {
//     material_no: "VET01E-216630A",
//     work_order: "211100402523",
//     plan_order: null,
//     qty: 11.0,
//     balance: 11.0,
//     start_date: "2024-08-30",
//     status: "REL",
//     type: "01E",
//     cal_kit: 0.0,
//     count_cal_kit: 0,
//     cal_kit_w1: 0.0,
//     count_cal_kit_w1: 0,
//   },
//   {
//     material_no: "VET01E-216630A",
//     work_order: "211100406381",
//     plan_order: null,
//     qty: 210.0,
//     balance: 210.0,
//     start_date: "2024-10-11",
//     status: "REL",
//     type: "01E",
//     cal_kit: 0.0,
//     count_cal_kit: 0,
//     cal_kit_w1: 18.57142857142857,
//     count_cal_kit_w1: 1,
//   },
//   {
//     material_no: "VET01E-216630B",
//     work_order: "211100406383",
//     plan_order: null,
//     qty: 360.0,
//     balance: 360.0,
//     start_date: "2024-10-11",
//     status: "REL",
//     type: "01E",
//     cal_kit: 0.0,
//     count_cal_kit: 0,
//     cal_kit_w1: 0.0,
//     count_cal_kit_w1: 0,
//   },
//   {
//     material_no: "VET01R-216630",
//     work_order: "211100406358",
//     plan_order: null,
//     qty: 210.0,
//     balance: 210.0,
//     start_date: "2024-10-21",
//     status: "REL",
//     type: "01R",
//     cal_kit: 0.0,
//     count_cal_kit: 0,
//     cal_kit_w1: 1.4285714285714164,
//     count_cal_kit_w1: 1,
//   },
// ];
// ****************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////// ขาด FG CHILD
data_fg = [
	{ material_no: "VET01P-9002114LF", fg_qty: 20 },
	{ material_no: "VET01E-217656", fg_qty: 2 }
];
tree_wo_child = Structure_WO_908(data_wo_child);
updateDetails_WOChild(tree_structure, tree_wo_child, data_fg);
function updateDetails_WOChild(tree_structure, tree_wo_child, data_fg) {
  // เตรียม Tree_WO ไว้คำนวณ
  for (let materialNo in tree_wo_child) {
    // ตัว entries ใน key tree_wo_child
    const entries = tree_wo_child[materialNo];
    entries.forEach((entry, index) => {
      //   console.log(entry);
      for (let key in tree_structure) {
        // console.log( );
        // if ( key.substring(0, 3) == entry["material_no"].substring(0, 3) ){
        // }
        let node_children = findAllNodesByChildId(
          tree_structure[key], // ใช้เฉพาะ tree_structure[key]
          entry["material_no"] // ใช้ entry["material_no"] เพื่อค้นหา
        );

        if (node_children.length > 0) {
          node_children.forEach((node) => {
            //   console.log(node["child_id"]);
            // console.log(node)
            if (node) {
              let fg_qty = 0;
              if (node["wo_len"] == 0) {
                fg_item = data_fg.find(
                  (item) => item.material_no === entry["material_no"]
                );
                fg_qty = fg_item?.["fg_qty"] || 0;
                node["detail"][0].fg_qty = fg_qty;
                node["detail"][0].work_order = entry.work_order;
                node["detail"][0].plan_order = null;
                node["detail"][0].wo_status = entry.status;
                node["detail"][0].wo_qty = entry.qty;
                node["detail"][0].wo_balance = entry.balance;
                node["detail"][0].wo_date = entry.start_date;
                node["detail"][0].cplk_per_o = entry.cal_kit;
                node["detail"][0].cplk_count_o = entry.count_cal_kit;
                node["detail"][0].cplk_per_n = entry.cal_kit_w1;
                node["detail"][0].cplk_count_n = entry.count_cal_kit_w1;
              } else {
                const newDetail = {
                  main_id: node["main_id"],
                  parent_id: node["parent_id"],
                  child_id: node["child_id"],
                  work_order: entry.work_order,
                  plan_order: null,
                  wo_status: entry.status,
                  wo_qty: entry.qty,
                  wo_balance: entry.balance,
                  wo_date: entry.start_date,
                  cplk_per_o: entry.cal_kit,
                  cplk_count_o: entry.count_cal_kit,
                  cplk_per_n: entry.cal_kit_w1,
                  cplk_count_n: entry.count_cal_kit_w1,
                };
                node["detail"].push(newDetail);
              }
              node["wo_len"] += 1;
              if (node["total"] > 0) {
                let temp_total = 0;
                temp_total = JSON.parse(JSON.stringify(node["total"]));
                if (fg_qty > 0) {
                  temp_total = temp_total - fg_qty;
                  if (temp_total > 0) {
                    fg_item["fg_qty"] = 0;
                    temp_total = temp_total - entry.qty;
                    if (temp_total > 0) {
                      entry.qty = 0;
                    } else {
                      entry.qty = Math.abs(temp_total);
                    }
                  } else {
                    fg_item["fg_qty"] = Math.abs(temp_total);
                  }
                } else {
                  temp_total = temp_total - entry.qty;
                  if (temp_total > 0) {
                    entry.qty = 0;
                  } else {
                    entry.qty = Math.abs(temp_total);
                  }
                }
                node["total"] = temp_total;
              }
            }
          });
        }
      }
    });
  }
}
// console.log(tree_wo_child)
// console.log(JSON.stringify(tree_wo_child, null, 2));
// console.log(JSON.stringify(tree_structure, null, 2));
/////////////////////////////////////////////////////////////    PLAN ค้น LEVEL > 0 (โดยหาว่า Summary มัน +แสดงว่ายังเหลือ)   ///////////////////////////////////////////////////////////////////
//////////////////// ค้นหา WO ที่เริ่ม level_1 ไว้เอาไปค้นหา WO ทำใน NODE
function findUniqueNodesPlan(tree_structure) {
  let uniqueNodes = new Set(); // ใช้ Set เพื่อเก็บค่าไม่ซ้ำกัน

  function traverseNode(node) {
    // ตรวจสอบว่า level_no มากกว่า 0
    if (node.level_no > 0) {
      if (node.total > 0) {
        uniqueNodes.add(node.child_id);
      }
      // uniqueNodes.add(node.child_id); // เก็บ child_id ไว้ใน Set
    }
    // ถ้ามี child ให้ทำการวนซ้ำเพื่อตรวจสอบ child แต่ละตัว
    if (node.child && node.child.length > 0) {
      for (let i = 0; i < node.child.length; i++) {
        traverseNode(node.child[i]); // ตรวจสอบ child ของโหนด
      }
    }
  }
  // วนลูปผ่าน tree_structure
  for (let key in tree_structure) {
    const node = tree_structure[key];
    traverseNode(node); // เริ่มการ traversal จากโหนดนี้
  }
  // แปลง Set ให้เป็น Array ถ้าต้องการ
  return Array.from(uniqueNodes);
}
// เรียกใช้งานฟังก์ชัน
const ChildNodesPlan = findUniqueNodesPlan(tree_structure);
// console.log(ChildNodesPlan);
/////////////////////////////////////////////////////////////    PLAN เพิ่มข้อมูลเข้าไป   ///////////////////////////////////////////////////////////////////
data_plan_child = [
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444855",
    qty: 40.0,
    balance: 40.0,
    start_date: "2025-02-07",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444856",
    qty: 5.0,
    balance: 5.0,
    start_date: "2025-03-01",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444857",
    qty: 5.0,
    balance: 5.0,
    start_date: "2025-03-05",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444858",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-04-10",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444859",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-06-13",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444860",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-08-15",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444861",
    qty: 55.0,
    balance: 55.0,
    start_date: "2025-10-09",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01E-217656",
    work_order: null,
    plan_order: "0158444862",
    qty: 55.0,
    balance: 55.0,
    start_date: "2025-11-13",
    status: "PLAN",
    type: "01E",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440320",
    qty: 1.0,
    balance: 1.0,
    start_date: "2024-10-21",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440321",
    qty: 44.0,
    balance: 44.0,
    start_date: "2025-02-15",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440322",
    qty: 4.0,
    balance: 4.0,
    start_date: "2025-03-10",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440323",
    qty: 2.0,
    balance: 2.0,
    start_date: "2025-03-13",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440324",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-04-18",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440325",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-06-21",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440326",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-08-23",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440327",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-10-18",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01P-217654",
    work_order: null,
    plan_order: "0158440328",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-11-21",
    status: "PLAN",
    type: "01P",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440464",
    qty: 42.0,
    balance: 42.0,
    start_date: "2025-02-15",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440465",
    qty: 4.0,
    balance: 4.0,
    start_date: "2025-03-10",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440466",
    qty: 2.0,
    balance: 2.0,
    start_date: "2025-03-13",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440467",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-04-18",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440468",
    qty: 50.0,
    balance: 50.0,
    start_date: "2025-06-21",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440469",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-08-23",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440470",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-10-18",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
  {
    material_no: "VET01R-217656",
    work_order: null,
    plan_order: "0158440471",
    qty: 54.0,
    balance: 54.0,
    start_date: "2025-11-21",
    status: "PLAN",
    type: "01R",
    cal_kit: 0.0,
    count_cal_kit: 0,
    cal_kit_w1: 0.0,
    count_cal_kit_w1: 0,
  },
];

function updateDetails_PLANChild(tree_structure, tree_plan_child, data_fg) {
  for (let materialNo in tree_plan_child) {
    const entries = tree_plan_child[materialNo];
    entries.forEach((entry, index) => {
      if (entry.qty > 0) {
        for (let key in tree_structure) {
          let node_children = findAllNodesByChildId(
            tree_structure[key],
            entry["material_no"]
          );
          if (node_children.length > 0) {
            if (entry.qty > 0) {
              node_children.forEach((node) => {
                if (node) {
                  if (entry.qty > 0) {
                    if (node["total"] > 0) {
                      let fg_qty = 0;
                      if (node["wo_len"] == 0) {
                        fg_item = data_fg.find(
                          (item) => item.material_no === entry["material_no"]
                        );
                        fg_qty = fg_item?.["fg_qty"] || 0;
                        node["detail"][0].fg_qty = fg_qty;
                        node["detail"][0].work_order = null;
                        node["detail"][0].plan_order = entry.plan_order;
                        node["detail"][0].wo_status = entry.status;
                        node["detail"][0].wo_qty = entry.qty;
                        node["detail"][0].wo_balance = entry.balance;
                        node["detail"][0].wo_date = entry.start_date;
                        node["detail"][0].cplk_per_o = entry.cal_kit;
                        node["detail"][0].cplk_count_o = entry.count_cal_kit;
                        node["detail"][0].cplk_per_n = entry.cal_kit_w1;
                        node["detail"][0].cplk_count_n = entry.count_cal_kit_w1;
                      } else {
                        const newDetail = {
                          main_id: node["main_id"],
                          parent_id: node["parent_id"],
                          child_id: node["child_id"],
                          work_order: null,
                          plan_order: entry.plan_order,
                          wo_status: entry.status,
                          wo_qty: entry.qty,
                          wo_balance: entry.balance,
                          wo_date: entry.start_date,
                          cplk_per_o: entry.cal_kit,
                          cplk_count_o: entry.count_cal_kit,
                          cplk_per_n: entry.cal_kit_w1,
                          cplk_count_n: entry.count_cal_kit_w1,
                        };
                        node["detail"].push(newDetail);
                      }
                      node["wo_len"] += 1;
                      if (node["total"] > 0) {
                        let temp_total = 0;
                        temp_total = JSON.parse(JSON.stringify(node["total"]));
                        if (fg_qty > 0) {
                          temp_total = temp_total - fg_qty;
                          if (temp_total > 0) {
                            fg_item["fg_qty"] = 0;
                            temp_total = temp_total - entry.qty;
                            if (temp_total > 0) {
                              entry.qty = 0;
                            } else {
                              entry.qty = Math.abs(temp_total);
                            }
                          } else {
                            fg_item["fg_qty"] = Math.abs(temp_total);
                          }
                        } else {
                          temp_total = temp_total - entry.qty;
                          if (temp_total > 0) {
                            entry.qty = 0;
                          } else {
                            entry.qty = Math.abs(temp_total);
                          }
                        }
                        node["total"] = temp_total;
                      }
                    }
                  }
                }
              });
            }
          }
        }
      }
    });
  }
}

tree_plan_child = Structure_WO_908(data_plan_child);
updateDetails_PLANChild(tree_structure, tree_plan_child, data_fg);
/////////////////////////////////////////////////////////////    FINAL    ///////////////////////////////////////////////////////////////////
// console.log(tree_structure);

function extractDetails(treeNode, onOrderTracker, currentMainId) {
  let details = [];

  // ตรวจสอบว่ามี field `detail` ไหม
  if (treeNode.detail && Array.isArray(treeNode.detail)) {
    treeNode.detail.forEach((detail) => {
      // รีเซ็ต on_order ถ้า main_id เปลี่ยน
      if (detail.main_id !== currentMainId.main_id) {
        currentMainId.main_id = detail.main_id;
        onOrderTracker.count = 0; // รีเซ็ต on_order เป็น 1 เมื่อเจอ main_id ใหม่
      }

      details.push({
        ...detail, // กระจายรายละเอียดเดิม
        on_order: onOrderTracker.count, // ใช้ onOrderTracker.count เป็น on_order
      });
    });
    // Summary
    details.push({
      main_id: treeNode["main_id"],
      parent_id: treeNode["parent_id"],
      child_id: treeNode["child_id"],
      parent_total: treeNode["parent_total"],
      total: treeNode["total"],
      qpa: treeNode["qpa"],
	  on_order: onOrderTracker.count,
    });
    onOrderTracker.count++; // เพิ่มค่า on_order ทีละ 1
  }

  // ถ้ามี child nodes ให้วนลูปเพื่อดึงข้อมูลในระดับลึกลงไป
  if (treeNode.child && Array.isArray(treeNode.child)) {
    treeNode.child.forEach((childNode) => {
      details = details.concat(
        extractDetails(childNode, onOrderTracker, currentMainId)
      );
    });
  }

  return details;
}

// วนลูปผ่านทุก key ใน tree_structure และนับ on_order ต่อเนื่อง
function final_x(tree_structure) {
  let allDetails = [];
  let onOrderTracker = { count: 0 }; // ใช้ตัวติดตามค่า on_order เริ่มจาก 1
  let currentMainId = { main_id: null }; // เก็บ main_id ล่าสุดที่เจอ

  for (let key in tree_structure) {
    if (tree_structure.hasOwnProperty(key)) {
      const rootNode = tree_structure[key]; // ดึง node จาก key แต่ละตัว
      const extractedDetails = extractDetails(
        rootNode,
        onOrderTracker,
        currentMainId
      ); // ดึงข้อมูลจาก node นั้นๆ และนับ on_order
      allDetails = allDetails.concat(extractedDetails); // รวมผลลัพธ์
    }
  }

  return allDetails;
}

allDetails = final_x(tree_structure);
console.log(allDetails);
